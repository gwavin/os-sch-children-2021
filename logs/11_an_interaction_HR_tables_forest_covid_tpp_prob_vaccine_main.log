-------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /workspace/logs/11_an_interaction_HR_tables_forest_covid_tpp_prob_
> vaccine_main.log
  log type:  text
 opened on:  13 Sep 2021, 10:01:18

. 
. *****************************************************************************
> ******************************************
. *Generic code to ouput the HRs across outcomes for all levels of a particular
>  variables, in the right shape for table
. cap prog drop outputHRsforvar

. prog define outputHRsforvar
  1. syntax, variable(string) min(real) max(real) outcome(string)
  2. file write tablecontents_int ("age") _tab ("exposure") _tab ("exposure lev
> el") ///
> _tab ("outcome") _tab ("int_type") _tab ("int_level") ///
> _tab ("events") _tab ("person_years") _tab ("rate") ///
> _tab ("HR")  _tab ("lci")  _tab ("uci") _tab ("pval") _n
  3. foreach x in 0 1 {
  4. forvalues i=`min'/`max'{
  5. foreach int_type in vaccine {
  6. 
. foreach int_level in 0 1 2 {
  7. 
. local endwith "_tab"
  8. 
.         *put the varname and condition to left so that alignment can be check
> ed vs shell
.         file write tablecontents_int ("`x'") _tab ("`variable'") _tab ("`i'")
>  _tab ("`outcome'") _tab ("`int_type'") _tab ("`int_level'") _tab
  9.  
.  use "$tempdir/cr_create_analysis_dataset_STSET_`outcome'_ageband_`x'.dta", c
> lear
 10. 
. *Censor at date of first child being vaccinated in hh
. replace stime_`outcome'         = under18vacc if stime_`outcome'>under18vacc
 11. stset stime_`outcome', fail(`outcome')          ///
>         id(patient_id) enter(enter_date) origin(enter_date)
 12. 
. gen first_vacc_plus_7d=covid_vacc_date+7
 13. gen second_vacc_plus_7d=covid_vacc_second_dose_date+7
 14. format first_vacc_plus_7d second_vacc_plus_7d %td
 15.  
. stsplit vaccine, after(first_vacc_plus_7d) at(0)
 16. replace vaccine = vaccine +1
 17. stsplit vaccine2, after(second_vacc_plus_7d) at(0)
 18. replace vaccine=2 if vaccine==1 &vaccine2==0 & second_vacc_plus_7d!=.
 19. recode `outcome' .=0 
 20. 
.         tab vaccine
 21.         tab vaccine `outcome' 
 22.         
.         
.         keep if vaccine==`int_level'
 23. *put total N, PYFU and Rate in table
.         cou if `variable' == `i' & _d == 1 
 24.         local event = r(N)
 25.     bysort `variable': egen total_follow_up = total(_t)
 26.         su total_follow_up if `variable' == `i'
 27.         local person_days = r(mean)
 28.         local person_years=`person_days'/365.25
 29.         local rate = 100000*(`event'/`person_years')
 30.         
.         file write tablecontents_int (`event') _tab %10.0f (`person_years') _
> tab %3.2f (`rate') _tab
 31.         drop total_follow_up
 32.  
.         foreach modeltype of any fulladj {
 33. 
.                 local noestimatesflag 0 /*reset*/
 34. 
. *CHANGE THE OUTCOME BELOW TO LAST IF BRINGING IN MORE COLS
.                 if "`modeltype'"=="fulladj" local endwith "_n"
 35. 
.                 ***********************
.                 *1) GET THE RIGHT ESTIMATES INTO MEMORY
. 
.                 if "`modeltype'"=="fulladj" {
 36.                                 cap estimates use ./output/an_interaction_
> cox_models_`outcome'_kids_cat4_`int_type'_`x'
 37.                                 if _rc!=0 local noestimatesflag 1
 38.                                 }
 39.                 ***********************
.                 *2) WRITE THE HRs TO THE OUTPUT FILE
. 
.                 if `noestimatesflag'==0{
 40.                         if `int_level'==0 {
 41.                         test 1.`int_type'#`i'.`variable'
 42.                         *overall p-value for interaction: test 1.`int_type
> '#1.`variable' test 1.`int_type'#2.`variable'
.                         local pval=r(p)
 43.                         cap lincom `i'.`variable', eform
 44.                         if _rc==0 file write tablecontents_int %4.2f (r(es
> timate)) _tab %4.2f (r(lb)) _tab %4.2f (r(ub)) _tab %4.2f (`pval') `endwith'
 45. 
.                                 else file write tablecontents_int %4.2f ("ERR
>  IN MODEL") `endwith'
 46.                                 }
 47.                         if `int_level'==1 {
 48.                         cap lincom `i'.`variable'+ 1.`int_type'#`i'.`varia
> ble', eform
 49.                         if _rc==0 file write tablecontents_int %4.2f (r(es
> timate)) _tab %4.2f (r(lb)) _tab %4.2f (r(ub)) _tab  `endwith'
 50.                                 else file write tablecontents_int %4.2f ("
> ERR IN MODEL") `endwith'
 51.                                 }
 52.                         
.                         if `int_level'==2 {
 53.                         cap lincom `i'.`variable'+ 2.`int_type'#`i'.`varia
> ble', eform
 54.                         if _rc==0 file write tablecontents_int %4.2f (r(es
> timate)) _tab %4.2f (r(lb)) _tab %4.2f (r(ub)) _tab  `endwith'
 55.                                 else file write tablecontents_int %4.2f ("
> ERR IN MODEL") `endwith'
 56.                                 }
 57.                         }
 58.                         
.                         else file write tablecontents_int %4.2f ("DID NOT FIT
> ") `endwith'
 59. 
.                 *3) Save the estimates for plotting
.                 if `noestimatesflag'==0{
 60.                         if "`modeltype'"=="fulladj" {
 61.                                 local hr = r(estimate)
 62.                                 local lb = r(lb)
 63.                                 local ub = r(ub)
 64.                                 cap gen `variable'=.
 65.                                 test 1.`int_type'#2.`variable' 1.`int_type
> '#1.`variable'
 66.                                 local pval=r(p)
 67.                                 post HRestimates_int ("`x'") ("`outcome'")
>  ("`variable'") ("`int_type'") (`i') (`int_level') (`hr') (`lb') (`ub') (`pva
> l')
 68.                                 drop `variable'
 69.                                 }
 70.                 }
 71.                 }
 72.                 } /*int_level*/
 73.                 } /*full adj*/
 74. 
. } /*variable levels*/
 75. }
 76. end

. *****************************************************************************
> ******************************************
. 
. *MAIN CODE TO PRODUCE TABLE CONTENTS
. cap file close tablecontents_int

. file open tablecontents_int using ./output/11_an_int_tab_contents_HRtable_`ou
> tcome'_vaccine_main.txt, t w replace
(note: file ./output/11_an_int_tab_contents_HRtable_covid_tpp_prob_vaccine_main
> .txt not found)

. 
. tempfile HRestimates_int

. cap postutil clear

. postfile HRestimates_int str10 x str10 outcome str27 variable str27 int_type 
> level int_level hr lci uci pval using `HRestimates_int'

. 
. *Primary exposure
. outputHRsforvar, variable("kids_cat4") min(0) max(3) outcome(`outcome')
(11,665 real changes made)

                id:  patient_id
     failure event:  covid_tpp_prob != 0 & covid_tpp_prob < .
obs. time interval:  (stime_covid_tpp_prob[_n-1], stime_covid_tpp_prob]
 enter on or after:  time enter_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time enter_date

------------------------------------------------------------------------------
     16,117  total observations
      3,500  observations end on or before enter()
------------------------------------------------------------------------------
     12,617  observations remaining, representing
     12,617  subjects
     10,412  failures in single-failure-per-subject data
    515,248  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =       208
(8,073 missing values generated)
(12,894 missing values generated)
(1,195 observations (episodes) created)
(13,812 real changes made)
(1,027 observations (episodes) created)
(815 real changes made)
(covid_tpp_prob: 2222 changes made)

observation |
   interval |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |      6,573       44.30       44.30
          1 |      7,451       50.21       94.51
          2 |        815        5.49      100.00
------------+-----------------------------------
      Total |     14,839      100.00

           |   Failure/censoring
           |     indicator for
           |  outcome: covid prob
observatio |         case
n interval |         0          1 |     Total
-----------+----------------------+----------
         0 |     2,439      4,134 |     6,573 
         1 |     1,830      5,621 |     7,451 
         2 |       158        657 |       815 
-----------+----------------------+----------
     Total |     4,427     10,412 |    14,839 
(11,766 observations deleted)
  122

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |        238       13895           0      13895      13895
1.vaccine#0.kids_cat4 not found
r(111);

end of do-file
r(111);

end of do-file

r(111);


