------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  C:\Users\qc18278\OneDrive - University of Bristol\Documents\GitHub\os-sch-children-2021\analysis\log/08_an_tablec
> ontent_HRtable_covid_tpp_prob.log
  log type:  text
 opened on:  24 Jul 2021, 14:54:03

. 
. 
. ***********************************************************************************************************************
. *Generic code to ouput the HRs across outcomes for all levels of a particular variables, in the right shape for table
. cap prog drop outputHRsforvar

. prog define outputHRsforvar
  1. syntax, variable(string) min(real) max(real) outcome(string)
  2. foreach period in 1 2 3 {
  3. forvalues x=0/1 {
  4. file write tablecontents ("age") ("`x'") _n
  5. forvalues i=`min'/`max'{
  6. local endwith "_tab"
  7. 
.         *put the varname and condition to left so that alignment can be checked vs shell
.         file write tablecontents ("`variable'") _tab ("`i'") _tab ("`period'") _tab 
  8.         
.         use "$tempdir/cr_create_analysis_dataset_STSET_`outcome'_ageband_`x'.dta", clear
  9.         *put total N, PYFU and Rate in table
.         cou if `variable' == `i' & _d == 1
 10.         local event = r(N)
 11.     bysort `variable': egen total_follow_up = total(_t)
 12.         su total_follow_up if `variable' == `i'
 13.         local person_days = r(mean)
 14.         local person_years=`person_days'/365.25
 15.         local rate = 100000*(`event'/`person_years')
 16.         
.         file write tablecontents (`event') _tab %10.0f (`person_years') _tab %3.2f (`rate') _tab
 17.         drop total_follow_up
 18.         
.         
.         *models
.         foreach modeltype of any minadj demogadj fulladj  {
 19.         
.                 local noestimatesflag 0 /*reset*/
 20. 
. *CHANGE THE OUTCOME BELOW TO LAST IF BRINGING IN MORE COLS
.                 if "`modeltype'"=="fulladj" local endwith "_n"
 21. 
.                 ***********************
.                 *1) GET THE RIGHT ESTIMATES INTO MEMORY
.                 
.                 if "`modeltype'"=="minadj" {
 22.                         cap estimates use ./output/an_univariable_cox_models_`variable'_`outcome'_AGESEX_ageband_`x'_time
> period`period'
 23.                         if _rc!=0 local noestimatesflag 1
 24.                         }
 25.                 if "`modeltype'"=="demogadj" {
 26.                         cap estimates use ./output/an_multivariate_cox_models_`outcome'_`variable'_DEMOGADJ_ageband_`x'_t
> imeperiod`period'
 27.                         if _rc!=0 local noestimatesflag 1
 28.                         }
 29.                 if "`modeltype'"=="fulladj" {
 30.                         cap estimates use ./output/an_multivariate_cox_models_`outcome'_`variable'_MAINFULLYADJMODEL_ageb
> and_`x'_timeperiod`period' 
 31.                         if _rc!=0 local noestimatesflag 1
 32.                         }
 33.                 
.                 ***********************
.                 *2) WRITE THE HRs TO THE OUTPUT FILE
.                 
.                 if `noestimatesflag'==0{
 34.                         cap lincom `i'.`variable', eform
 35.                         if _rc==0 file write tablecontents %4.2f (r(estimate)) (" (") %4.2f (r(lb)) ("-") %4.2f (r(ub)) (
> ")") `endwith'
 36.                                 else file write tablecontents %4.2f ("ERR IN MODEL") `endwith'
 37.                         }
 38.                         else file write tablecontents %4.2f ("DID NOT FIT") `endwith' 
 39.                         
.                 *3) Save the estimates for plotting
.                 if `noestimatesflag'==0{
 40.                         if "`modeltype'"=="fulladj" {
 41.                                 local hr = r(estimate)
 42.                                 local lb = r(lb)
 43.                                 local ub = r(ub)
 44.                                 cap gen `variable'=.
 45.                                 testparm i.`variable'
 46.                                 *drop `variable'
.                                 }
 47.                 }       
 48.                 } /*min adj, full adj*/
 49.                 
. } /*variable levels*/
 50. 
. } /*agebands*/
 51. 
. } /*Waves*/
 52. end

. ***********************************************************************************************************************
. /*Generic code to write a full row of "ref category" to the output file
> cap prog drop refline
> prog define refline
> file write tablecontents _tab _tab ("1.00 (ref)") _tab ("1.00 (ref)")  _n
> end*/
. ***********************************************************************************************************************
. 
. *MAIN CODE TO PRODUCE TABLE CONTENTS
. 
. cap file close tablecontents

. file open tablecontents using ./output/an_tablecontents_HRtable_`outcome'.txt, t w replace 

. 
. *Primary exposure
. outputHRsforvar, variable("kids_cat4") min(0) max(3) outcome(`outcome')
  369

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |        405       41557           0      41557      41557

 ( 1)  1.kids_cat4 = 0
 ( 2)  2.kids_cat4 = 0
 ( 3)  3.kids_cat4 = 0

           chi2(  3) =    8.05
         Prob > chi2 =    0.0449
  1,446

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |      1,561      152532           0     152532     152532

 ( 1)  1.kids_cat4 = 0
 ( 2)  2.kids_cat4 = 0
 ( 3)  3.kids_cat4 = 0

           chi2(  3) =    8.05
         Prob > chi2 =    0.0449
  252

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |        273       26627           0      26627      26627

 ( 1)  1.kids_cat4 = 0
 ( 2)  2.kids_cat4 = 0
 ( 3)  3.kids_cat4 = 0

           chi2(  3) =    8.05
         Prob > chi2 =    0.0449
  12,842

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |     13,768     1365840           0    1365840    1365840

 ( 1)  1.kids_cat4 = 0
 ( 2)  2.kids_cat4 = 0
 ( 3)  3.kids_cat4 = 0

           chi2(  3) =    8.05
         Prob > chi2 =    0.0449
  132

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |        143       13684           0      13684      13684

 ( 1)  1.kids_cat4 = 0
 ( 2)  2.kids_cat4 = 0
 ( 3)  3.kids_cat4 = 0

           chi2(  3) =    2.22
         Prob > chi2 =    0.5284
  422

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |        455       45311           0      45311      45311

 ( 1)  1.kids_cat4 = 0
 ( 2)  2.kids_cat4 = 0
 ( 3)  3.kids_cat4 = 0

           chi2(  3) =    2.22
         Prob > chi2 =    0.5284
  82

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |         85        8332           0       8332       8332

 ( 1)  1.kids_cat4 = 0
 ( 2)  2.kids_cat4 = 0
 ( 3)  3.kids_cat4 = 0

           chi2(  3) =    2.22
         Prob > chi2 =    0.5284
  3,635

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |      3,922      389458           0     389458     389458

 ( 1)  1.kids_cat4 = 0
 ( 2)  2.kids_cat4 = 0
 ( 3)  3.kids_cat4 = 0

           chi2(  3) =    2.22
         Prob > chi2 =    0.5284
  369

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |        405       41557           0      41557      41557

 ( 1)  1.kids_cat4 = 0
 ( 2)  2.kids_cat4 = 0
 ( 3)  3.kids_cat4 = 0

           chi2(  3) =    1.32
         Prob > chi2 =    0.7241
  1,446

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |      1,561      152532           0     152532     152532

 ( 1)  1.kids_cat4 = 0
 ( 2)  2.kids_cat4 = 0
 ( 3)  3.kids_cat4 = 0

           chi2(  3) =    1.32
         Prob > chi2 =    0.7241
  252

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |        273       26627           0      26627      26627

 ( 1)  1.kids_cat4 = 0
 ( 2)  2.kids_cat4 = 0
 ( 3)  3.kids_cat4 = 0

           chi2(  3) =    1.32
         Prob > chi2 =    0.7241
  12,842

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |     13,768     1365840           0    1365840    1365840

 ( 1)  1.kids_cat4 = 0
 ( 2)  2.kids_cat4 = 0
 ( 3)  3.kids_cat4 = 0

           chi2(  3) =    1.32
         Prob > chi2 =    0.7241
  132

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |        143       13684           0      13684      13684

 ( 1)  1.kids_cat4 = 0
 ( 2)  2.kids_cat4 = 0
 ( 3)  3.kids_cat4 = 0

           chi2(  3) =    1.22
         Prob > chi2 =    0.7490
  422

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |        455       45311           0      45311      45311

 ( 1)  1.kids_cat4 = 0
 ( 2)  2.kids_cat4 = 0
 ( 3)  3.kids_cat4 = 0

           chi2(  3) =    1.22
         Prob > chi2 =    0.7490
  82

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |         85        8332           0       8332       8332

 ( 1)  1.kids_cat4 = 0
 ( 2)  2.kids_cat4 = 0
 ( 3)  3.kids_cat4 = 0

           chi2(  3) =    1.22
         Prob > chi2 =    0.7490
  3,635

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |      3,922      389458           0     389458     389458

 ( 1)  1.kids_cat4 = 0
 ( 2)  2.kids_cat4 = 0
 ( 3)  3.kids_cat4 = 0

           chi2(  3) =    1.22
         Prob > chi2 =    0.7490
  369

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |        405       41557           0      41557      41557
  1,446

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |      1,561      152532           0     152532     152532
  252

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |        273       26627           0      26627      26627
  12,842

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |     13,768     1365840           0    1365840    1365840
  132

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |        143       13684           0      13684      13684
  422

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |        455       45311           0      45311      45311
  82

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |         85        8332           0       8332       8332
  3,635

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |      3,922      389458           0     389458     389458

. file write tablecontents _n

. 
. *Number kids
. outputHRsforvar, variable("gp_number_kids") min(0) max(4) outcome(`outcome')
  0

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |          0

 ( 1)  2.gp_number_kids = 0
 ( 2)  3.gp_number_kids = 0
 ( 3)  4.gp_number_kids = 0

           chi2(  3) =    2.04
         Prob > chi2 =    0.5638
  394

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |        424       41552           0      41552      41552

 ( 1)  2.gp_number_kids = 0
 ( 2)  3.gp_number_kids = 0
 ( 3)  4.gp_number_kids = 0

           chi2(  3) =    2.04
         Prob > chi2 =    0.5638
  265

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |        284       27075           0      27075      27075

 ( 1)  2.gp_number_kids = 0
 ( 2)  3.gp_number_kids = 0
 ( 3)  4.gp_number_kids = 0

           chi2(  3) =    2.04
         Prob > chi2 =    0.5638
  261

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |        279       28437           0      28437      28437

 ( 1)  2.gp_number_kids = 0
 ( 2)  3.gp_number_kids = 0
 ( 3)  4.gp_number_kids = 0

           chi2(  3) =    2.04
         Prob > chi2 =    0.5638
  526

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |        574       55468           0      55468      55468

 ( 1)  2.gp_number_kids = 0
 ( 2)  3.gp_number_kids = 0
 ( 3)  4.gp_number_kids = 0

           chi2(  3) =    2.04
         Prob > chi2 =    0.5638
  0

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |          0

 ( 1)  2.gp_number_kids = 0
 ( 2)  3.gp_number_kids = 0
 ( 3)  4.gp_number_kids = 0

           chi2(  3) =    4.35
         Prob > chi2 =    0.2260
  124

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |        136       13407           0      13407      13407

 ( 1)  2.gp_number_kids = 0
 ( 2)  3.gp_number_kids = 0
 ( 3)  4.gp_number_kids = 0

           chi2(  3) =    4.35
         Prob > chi2 =    0.2260
  71

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |         76        8502           0       8502       8502

 ( 1)  2.gp_number_kids = 0
 ( 2)  3.gp_number_kids = 0
 ( 3)  4.gp_number_kids = 0

           chi2(  3) =    4.35
         Prob > chi2 =    0.2260
  67

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |         74        7137           0       7137       7137

 ( 1)  2.gp_number_kids = 0
 ( 2)  3.gp_number_kids = 0
 ( 3)  4.gp_number_kids = 0

           chi2(  3) =    4.35
         Prob > chi2 =    0.2260
  160

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |        169       16265           0      16265      16265

 ( 1)  2.gp_number_kids = 0
 ( 2)  3.gp_number_kids = 0
 ( 3)  4.gp_number_kids = 0

           chi2(  3) =    4.35
         Prob > chi2 =    0.2260
  0

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |          0

 ( 1)  2.gp_number_kids = 0
 ( 2)  3.gp_number_kids = 0
 ( 3)  4.gp_number_kids = 0

           chi2(  3) =    8.65
         Prob > chi2 =    0.0344
  394

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |        424       41552           0      41552      41552

 ( 1)  2.gp_number_kids = 0
 ( 2)  3.gp_number_kids = 0
 ( 3)  4.gp_number_kids = 0

           chi2(  3) =    8.65
         Prob > chi2 =    0.0344
  265

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |        284       27075           0      27075      27075

 ( 1)  2.gp_number_kids = 0
 ( 2)  3.gp_number_kids = 0
 ( 3)  4.gp_number_kids = 0

           chi2(  3) =    8.65
         Prob > chi2 =    0.0344
  261

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |        279       28437           0      28437      28437

 ( 1)  2.gp_number_kids = 0
 ( 2)  3.gp_number_kids = 0
 ( 3)  4.gp_number_kids = 0

           chi2(  3) =    8.65
         Prob > chi2 =    0.0344
  526

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |        574       55468           0      55468      55468

 ( 1)  2.gp_number_kids = 0
 ( 2)  3.gp_number_kids = 0
 ( 3)  4.gp_number_kids = 0

           chi2(  3) =    8.65
         Prob > chi2 =    0.0344
  0

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |          0

 ( 1)  2.gp_number_kids = 0
 ( 2)  3.gp_number_kids = 0
 ( 3)  4.gp_number_kids = 0

           chi2(  3) =    1.35
         Prob > chi2 =    0.7174
  124

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |        136       13407           0      13407      13407

 ( 1)  2.gp_number_kids = 0
 ( 2)  3.gp_number_kids = 0
 ( 3)  4.gp_number_kids = 0

           chi2(  3) =    1.35
         Prob > chi2 =    0.7174
  71

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |         76        8502           0       8502       8502

 ( 1)  2.gp_number_kids = 0
 ( 2)  3.gp_number_kids = 0
 ( 3)  4.gp_number_kids = 0

           chi2(  3) =    1.35
         Prob > chi2 =    0.7174
  67

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |         74        7137           0       7137       7137

 ( 1)  2.gp_number_kids = 0
 ( 2)  3.gp_number_kids = 0
 ( 3)  4.gp_number_kids = 0

           chi2(  3) =    1.35
         Prob > chi2 =    0.7174
  160

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |        169       16265           0      16265      16265

 ( 1)  2.gp_number_kids = 0
 ( 2)  3.gp_number_kids = 0
 ( 3)  4.gp_number_kids = 0

           chi2(  3) =    1.35
         Prob > chi2 =    0.7174
  0

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |          0
  394

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |        424       41552           0      41552      41552
  265

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |        284       27075           0      27075      27075
  261

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |        279       28437           0      28437      28437
  526

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |        574       55468           0      55468      55468
  0

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |          0
  124

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |        136       13407           0      13407      13407
  71

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |         76        8502           0       8502       8502
  67

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |         74        7137           0       7137       7137
  160

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |        169       16265           0      16265      16265

. file write tablecontents _n 

. 
. file close tablecontents

. 
. 
. log close
      name:  <unnamed>
       log:  C:\Users\qc18278\OneDrive - University of Bristol\Documents\GitHub\os-sch-children-2021\analysis\log/08_an_tablec
> ontent_HRtable_covid_tpp_prob.log
  log type:  text
 closed on:  24 Jul 2021, 14:54:40
------------------------------------------------------------------------------------------------------------------------------
